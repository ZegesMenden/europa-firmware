#include "core.h"
#include "pico/multicore.h"

#pragma once

namespace simulation {

	// const float c6_thrust[] = { 0.0,0.3296616488367361,0.6293540568701328,0.9290464649035295,1.5537129265930751,2.178379388282621,2.8030458499721647,3.4277123116617085,
	// 4.052378773351253,4.677045235040802,5.70048635201434,6.768235764019432,7.835985176024525,8.903734588029609,9.83490685318774,10.604634208728305,
	// 11.374361564268872,12.144088919809437,12.913816275350005,13.683543630890572,12.615552102518523,11.059411615436026,9.244797988762558,7.430184362089087,
	// 6.680272731131041,6.025990358629265,5.878232151881686,5.730473945134105,5.582715738386525,5.434957531638944,5.340569236627502,5.26905376093156,
	// 5.197538285235617,5.126022809539674,5.054507333843732,4.982991858147789,4.9114763824518475,4.839960906755905,4.797417112904286,4.753176805051734,
	// 4.708936497199182,4.664696189346629,4.6204558814940775,4.576215573641525,4.531975265788973,4.4877349579364205,4.443494650083868,4.399254342231316,
	// 4.365430081490382,4.355909930676445,4.346389779862506,4.336869629048569,4.327349478234631,4.317829327420694,4.308309176606755,4.298789025792818,
	// 4.28926887497888,4.279748724164943,4.270228573351004,4.260708422537067,4.251188271723129,4.241668120909192,4.232147970095254,4.222627819281316,
	// 4.213107668467378,4.203587517653441,4.194067366839503,4.184547216025565,4.235673820177714,4.325644902504867,4.41561598483202,4.372214441596736,
	// 4.195440272799026,4.095964205108133,4.117925650400588,4.139887095693044,4.161848540985499,4.1838099862779545,4.20577143157041,4.227732876862866,
	// 4.249694322155322,4.271655767447777,4.293617212740233,4.315578658032688,4.337540103325144,4.359501548617599,4.365658028763392,4.361277865478106,
	// 4.35689770219282,4.352517538907535,4.348137375622249,4.343757212336964,4.339377049051678,4.334996885766392,4.330616722481107,4.326236559195821,
	// 4.321856395910536,4.31747623262525,4.313096069339964,4.308715906054679,4.304335742769393,4.299955579484108,4.2955754161988216,4.2911952529135355,
	// 4.28681508962825,4.282434926342964,4.278054763057679,4.274988648757993,4.274988648757993,4.274988648757993,4.274988648757993,4.274988648757993,
	// 4.274988648757993,4.274988648757993,4.274988648757993,4.274988648757993,4.274988648757993,4.274988648757993,4.274988648757993,4.274988648757993,
	// 4.274988648757993,4.274988648757993,4.239000215827132,4.14902913349998,4.059058051172826,4.005206795703052,4.0356351362338065,4.066063476764561,
	// 4.096491817295314,4.126920157826069,4.157348498356823,4.1828220493023505,4.188476441906988,4.194130834511625,4.199785227116262,4.2054396197209,
	// 4.211094012325536,4.216748404930174,4.222402797534811,4.228057190139448,4.233711582744085,4.239365975348723,4.24502036795336,4.250674760557997,
	// 4.256329153162635,4.261983545767271,4.267637938371909,4.273292330976546,4.277966227842351,4.282928859649616,4.28789149145688,4.292854123264144,
	// 4.297816755071408,4.302779386878672,4.307742018685936,4.3127046504932,4.317667282300464,4.322629914107728,4.327592545914992,4.332555177722257,
	// 4.337517809529521,4.342480441336785,4.347443073144049,4.352405704951313,4.357368336758578,4.362330968565841,4.367293600373105,4.368286126734564,
	// 4.368286126734564,4.368286126734564,4.368286126734564,4.368286126734564,4.368286126734564,4.368286126734564,4.368286126734564,4.368286126734564,
	// 4.368286126734564,4.368286126734564,4.368286126734564,4.368286126734564,4.368286126734564,4.368286126734564,4.368286126734564,4.139386241496504,
	// 2.994886815306201,1.9086322113992165,0.8007718757503225,0.0,0.0,0.0,0.0,0.0,
	// 0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0};

	const float d12_thrust[] = {0.0,0.5896566578293295,1.1257081649469016,1.6617596720644745,2.1978111791820476,2.8341927625961945,3.871894651196643,4.909596539797095,5.9472984283975485,6.9850003169980015,8.022702205598454,
	9.060404094198907,10.173624378675838,11.362363059029285,12.551101739382732,13.73984041973618,14.928579100089626,16.117317780443074,17.306056460796533,18.605658559663237,19.952773552178474,
	21.299888544693715,22.647003537208953,23.99411852972419,25.299703103280766,26.542992048399242,27.786280993517718,29.029569938636193,30.272858883754672,28.728563141396947,26.64752939544121,
	23.41880499085432,19.676144357453115,17.48202050500016,15.962515038167613,14.443009571335075,13.897617714566763,13.352225857798434,12.806834001030104,12.346949585925739,12.111240289029016,
	11.875530992132294,11.639821695235572,11.40411239833885,11.168403101442127,11.004735205870048,10.913108711622646,10.821482217375246,10.729855723127846,10.638229228880446,10.546602734633044,
	10.454976240385644,10.363349746138244,10.271723251890844,10.180096757643442,10.088470263396042,10.063749674854192,10.029866436887673,9.995983198921152,9.962099960954633,9.928216722988113,
	9.894333485021594,9.860450247055075,9.826567009088555,9.792683771122036,9.758800533155515,9.724917295188996,9.691034057222478,9.657150819255957,9.623267581289438,9.589384343322918,
	9.555501105356399,9.521617867389878,9.504629505266815,9.491864862104796,9.47910021894278,9.46633557578076,9.453570932618742,9.440806289456724,9.428041646294705,9.415277003132687,
	9.402512359970668,9.389747716808651,9.376983073646633,9.364218430484614,9.351453787322596,9.338689144160577,9.325924500998559,9.31315985783654,9.302638120087591,9.291484212087129,
	9.280330304086668,9.269176396086205,9.258022488085745,9.246868580085282,9.23571467208482,9.224560764084359,9.213406856083896,9.202252948083435,9.191099040082973,9.17994513208251,
	9.16879122408205,9.157637316081587,9.146483408081126,9.135329500080664,9.124175592080201,9.11302168407974,9.101867776079278,9.092058955413549,9.081192168081515,9.07032538074948,
	9.059458593417446,9.04859180608541,9.037725018753376,9.026858231421341,9.015991444089305,9.005124656757271,8.994257869425237,8.983391082093203,8.972524294761167,8.961657507429132,
	8.950790720097098,8.939923932765064,8.929057145433028,8.918190358100993,8.907323570768959,8.896456783436923,8.877683052850708,8.85552063229858,8.833358211746452,8.811195791194322,
	8.789033370642194,8.766870950090066,8.744708529537938,8.72254610898581,8.700383688433682,8.678221267881554,8.656058847329426,8.633896426777298,8.61173400622517,8.589571585673042,
	8.567409165120914,8.545246744568786,8.523084324016658,8.50092190346453,8.495745825487305,8.494683548534878,8.493621271582452,8.492558994630027,8.4914967176776,8.490434440725174,
	8.48937216377275,8.488309886820323,8.487247609867897,8.486185332915472,8.485123055963046,8.48406077901062,8.482998502058194,8.481936225105768,8.480873948153343,8.1379842263724,
	6.427253586801124,4.716522947229848,3.5994517228859277,2.3582614736149083,1.117071224343891,0.0};

	const float e12_thrust[] = {
		0.9701923076923077,1.9403846153846154,2.910576923076923,3.8807692307692307,4.850961538461538,5.821153846153846,6.150681818181818,7.256363636363636,8.362045454545454,9.467727272727272,10.57340909090909,11.3334,12.756799999999998,
		14.180199999999997,15.603599999999997,17.026999999999997,18.4504,19.8738,21.2972,22.7206,24.144000000000002,25.454363636363635,26.76472727272727,28.075090909090907,29.385454545454543,30.69581818181818,32.006181818181815,31.801555555555556,32.25211111111111,32.702666666666666,33.15322222222222,30.616846153846154,28.26069230769231,27.002499999999998,24.095,21.1875,18.28,15.3725,16.077384615384616,
		15.037769230769232,13.998153846153848,13.933666666666667,13.453333333333335,12.973000000000003,12.49266666666667,12.8469,12.720799999999999,12.594699999999998,12.468599999999997,12.342499999999996,12.216399999999995,12.090299999999994,11.964199999999993,11.838099999999992,11.71199999999999,
		11.6579,11.6038,11.5497,11.4956,11.4415,11.3874,11.3333,11.2792,11.2251,11.171,11.116999999999999,11.062999999999999,11.008999999999999,10.954999999999998,10.900999999999998,10.846999999999998,10.792999999999997,10.738999999999997,10.684999999999997,10.630999999999997,10.5769,
		10.5228,10.4687,10.4146,10.3605,10.3064,10.2523,10.1982,10.1441,10.09,10.0359,10.054,10.018,9.982000000000001,9.946000000000002,9.910000000000002,9.874000000000002,9.838000000000003,9.802000000000003,9.766000000000004,9.730000000000004,9.712,
		9.693999999999999,9.675999999999998,9.657999999999998,9.639999999999997,9.621999999999996,9.603999999999996,9.585999999999995,9.567999999999994,9.549999999999994,9.585643564356436,9.621287128712872,9.656930693069308,9.692574257425743,9.728217821782179,9.763861386138615,9.79950495049505,9.835148514851486,9.870792079207922,9.906435643564357,9.942079207920793,9.873636363636363,9.837272727272726,
		9.800909090909089,9.764545454545452,9.728181818181815,9.691818181818178,9.65545454545454,9.619090909090904,9.582727272727267,9.54636363636363,9.568000000000001,9.586000000000002,9.604000000000003,9.622000000000003,9.640000000000004,9.658000000000005,9.676000000000005,9.694000000000006,9.712000000000007,9.730000000000008,9.748000000000008,9.73,
		9.73,9.73,9.73,9.73,9.73,9.73,9.73,9.73,9.73,9.73,9.73,9.73,9.73,9.73,9.73,9.73,9.73,9.73,9.73,9.73,9.73,9.73,9.73,9.73,9.73,9.73,9.73,9.73,9.73,9.73,9.73,9.712,
		9.693999999999999,9.675999999999998,9.657999999999998,9.639999999999997,9.621999999999996,9.603999999999996,9.585999999999995,9.567999999999994,9.549999999999994,9.568000000000001,9.586000000000002,9.604000000000003,9.622000000000003,9.640000000000004,9.658000000000005,9.676000000000005,9.694000000000006,9.712000000000007,9.730000000000008,9.748000000000008,
		9.73,9.73,9.73,9.73,9.73,9.73,9.73,9.73,9.73,9.73,9.712,9.693999999999999,9.675999999999998,9.657999999999998,9.639999999999997,9.621999999999996,9.603999999999996,9.585999999999995,9.567999999999994,9.549999999999994,9.531999999999993,9.55,
		9.55,9.55,9.55,9.55,9.55,9.55,9.55,9.55,9.55,9.55,9.568000000000001,9.586000000000002,9.604000000000003,9.622000000000003,9.640000000000004,9.658000000000005,9.676000000000005,9.694000000000006,9.712000000000007,9.730000000000008,9.748000000000008,9.676,9.622,9.568,9.514,
		9.459999999999999,9.405999999999999,9.351999999999999,9.297999999999998,9.243999999999998,9.189999999999998,9.213999999999999,9.237999999999998,9.261999999999997,9.285999999999996,9.309999999999995,9.333999999999994,9.357999999999993,9.381999999999993,8.001999999999995,6.633999999999991,5.265999999999986,4.462500000000001,2.9750000000000023,1.4875000000000036,4.884981308350689e-15,0.0
	};

	const float f15_thrust[] = {
		0.5160810810810811,1.0321621621621622,1.5482432432432431,2.0643243243243243,2.5804054054054055,3.0964864864864867,3.612567567567568,4.128648648648649,4.64472972972973,5.160810810810811,5.676891891891892,6.1929729729729734,6.709054054054055,7.225135135135136,7.741216216216217,8.214875,8.791749999999999,9.368624999999998,9.945499999999997,10.522374999999997,11.099249999999996,11.676124999999995,12.252999999999995,
		12.829874999999994,12.879969696969697,13.506939393939394,14.133909090909091,14.760878787878788,15.387848484848485,16.014818181818182,16.641787878787877,17.03828813559322,17.68557627118644,18.332864406779663,18.980152542372885,19.627440677966106,20.274728813559328,21.087931034482757,21.965862068965514,22.84379310344827,23.432756756756756,24.109513513513512,24.78627027027027,25.463027027027024,24.883103448275865,24.506206896551728,24.12931034482759,23.752413793103454,23.375517241379317,
		22.99862068965518,22.555627906976746,22.03725581395349,21.518883720930233,21.000511627906977,20.48213953488372,20.605,20.365000000000002,20.125000000000004,19.885000000000005,19.645000000000007,19.40500000000001,19.16500000000001,18.92500000000001,18.925315789473686,18.75763157894737,18.589947368421058,18.422263157894744,18.25457894736843,18.086894736842115,17.9192105263158,17.751526315789487,17.583842105263173,17.41615789473686,17.42365269461078,17.34730538922156,
		17.27095808383234,17.19461077844312,17.1182634730539,17.04191616766468,16.96556886227546,16.88922155688624,16.81287425149702,16.7365269461078,16.66017964071858,16.58383233532936,16.507485029940142,16.431137724550922,16.354790419161702,16.278443113772482,16.202095808383262,16.181153846153848,16.137307692307694,16.09346153846154,16.049615384615386,16.005769230769232,15.961923076923078,15.918076923076924,15.87423076923077,15.830384615384617,15.786538461538463,15.742692307692309,
		15.698846153846155,15.655000000000001,15.611153846153847,15.567307692307693,15.52346153846154,15.479615384615386,15.435769230769232,15.391923076923078,15.398488095238095,15.36997619047619,15.341464285714286,15.312952380952382,15.284440476190477,15.255928571428573,15.227416666666668,15.198904761904764,15.17039285714286,15.141880952380955,15.11336904761905,15.084857142857146,15.056345238095242,15.027833333333337,14.999321428571433,14.970809523809528,14.942297619047624,14.933275229357799,
		14.918550458715597,14.903825688073395,14.889100917431193,14.874376146788991,14.85965137614679,14.844926605504588,14.830201834862386,14.815477064220184,14.800752293577982,14.78602752293578,14.771302752293579,14.756577981651377,14.741853211009175,14.727128440366974,14.712403669724772,14.69767889908257,14.682954128440368,14.668229357798166,14.653504587155965,14.638779816513763,14.624055045871561,15.011137931034485,15.395275862068969,15.779413793103453,15.553549019607843,
		15.366098039215686,15.178647058823529,14.991196078431372,14.803745098039215,14.616294117647058,14.778047210300429,14.771094420600857,14.764141630901285,14.757188841201714,14.750236051502142,14.74328326180257,14.736330472102999,14.729377682403427,14.722424892703856,14.715472103004284,14.708519313304713,14.701566523605141,14.69461373390557,14.687660944205998,14.680708154506426,14.673755364806855,14.666802575107283,14.659849785407712,14.65289699570814,14.645944206008569,14.638991416308997,14.632038626609425,14.625085836909854,14.618133047210282,
		14.60838812785388,14.59377625570776,14.579164383561642,14.564552511415522,14.549940639269403,14.535328767123284,14.520716894977165,14.506105022831045,14.491493150684926,14.476881278538807,14.462269406392688,14.447657534246568,14.433045662100449,14.41843378995433,14.40382191780821,14.389210045662091,14.374598173515972,14.359986301369853,14.345374429223734,14.330762557077614,14.316150684931495,14.301538812785376,14.296647058823531,14.290294117647061,14.283941176470591,14.277588235294122,14.271235294117652,14.264882352941182,
		14.258529411764712,14.252176470588243,14.245823529411773,14.239470588235303,14.233117647058833,14.226764705882363,14.220411764705894,14.214058823529424,14.207705882352954,14.201352941176484,14.195000000000014,14.188647058823545,14.182294117647075,14.175941176470605,14.169588235294135,14.163235294117666,14.156882352941196,14.150529411764726,14.144176470588256,14.137823529411786,14.129661971830986,14.118323943661972,14.106985915492958,14.095647887323944,14.08430985915493,14.072971830985916,14.061633802816901,14.050295774647887,14.038957746478873,14.02761971830986,14.016281690140845,14.004943661971831,
		13.993605633802817,13.982267605633803,13.970929577464789,13.959591549295775,13.94825352112676,13.936915492957747,13.925577464788732,13.914239436619718,13.902901408450704,13.89156338028169,13.880225352112676,13.868887323943662,13.857549295774648,13.846211267605634,13.83487323943662,13.823535211267606,13.812197183098592,13.801118959107807,13.783237918215614,13.76535687732342,13.747475836431226,13.729594795539033,13.711713754646839,13.693832713754645,13.675951672862452,13.658070631970258,13.640189591078064,13.62230855018587,13.604427509293677,13.586546468401483,13.56866542750929,13.550784386617096,
		13.532903345724902,13.515022304832708,13.497141263940515,13.479260223048321,13.461379182156127,13.443498141263934,13.42561710037174,13.407736059479546,13.389855018587353,13.37197397769516,13.354092936802965,13.336211895910772,13.337887955182072,13.337775910364146,13.337663865546219,13.337551820728292,13.337439775910365,13.337327731092438,13.337215686274511,13.337103641456585,13.336991596638658,13.336879551820731,13.336767507002804,13.336655462184877,13.33654341736695,13.336431372549024,13.336319327731097,13.33620728291317,
		13.336095238095243,13.335983193277317,13.33587114845939,13.335759103641463,13.335647058823536,13.33553501400561,13.335422969187682,13.335310924369756,13.335198879551829,13.335086834733902,13.334974789915975,13.334862745098048,13.334750700280122,13.334638655462195,13.334526610644268,13.334414565826341,13.334302521008414,13.334190476190487,13.33407843137256,13.333966386554634,13.321748091603054,13.309496183206107,13.297244274809161,13.284992366412215,13.272740458015269,13.260488549618323,13.248236641221377,13.23598473282443,13.223732824427485,
		13.211480916030538,13.199229007633592,13.186977099236646,13.1747251908397,13.162473282442754,13.150221374045808,13.137969465648862,13.125717557251916,13.11346564885497,13.101213740458023,13.088961832061077,13.076709923664131,13.064458015267185,13.052206106870239,13.039954198473293,13.027702290076347,13.0154503816794,13.003198473282454,11.348909090909075,9.684818181818152,8.020727272727228,6.168428571428624,2.984857142857248,3.365312500000001,1.8356250000000023,0.30593750000000375,0.0
	};

	// ============================================================
	// ascent simulation

	struct ascent_sim_input {
		float position;
		float velocity;
		float acceleration;
		float deviation_from_up;
		float mass;
		float time;
	} ascent_sim_input;

	struct ascent_sim_output {
		float energy;
		float time;
		float position;
		uint32_t time_taken;
	} ascent_sim_output;

	void run_ascent_sim() {

		uint64_t t_start = time_us_64();

		float pos = ascent_sim_input.position;
		float vel = ascent_sim_input.velocity;
		float acc = ascent_sim_input.acceleration;
		float mass = ascent_sim_input.mass;
		float time = ascent_sim_input.time;

		float aero_coeff = 0.0f;
		if ( vel != 0.0 ) { aero_coeff = ( (mass*acc) - clamp(int((time)*100.f), 0, 199) )/(vel*vel); }

		float dt = 0.01f;

		while ( time < 8.0f && pos > -1.0f ) {

			float force = -aero_coeff*vel*vel;
			// force += c6_thrust[clamp(int((time)*100.f), 0, 199)];
			force += d12_thrust[clamp(int((time)*100.f), 0, 166)];
			vel += (-9.816 + (force / mass)) * dt;
			pos += vel*dt;
			time += dt;

			if ( vel < 0 ) { break; }

		}

		ascent_sim_output.position = pos;
		ascent_sim_output.energy = vel*vel*0.5*mass + mass*pos*9.816;
		ascent_sim_output.time = time;
		ascent_sim_output.time_taken = uint32_t(time_us_64() - t_start);

	}

	// ============================================================
	// landing burn simulation

	struct landing_sim_input {
		float position;
		float velocity;
		float acceleration;
		float mass;
		float burn_alt;
	} landing_sim_input;

	struct landing_sim_output {
		float position;
		float velocity;
		float work_done;
		float time;
		uint32_t time_taken;
	} landing_sim_output;

	void run_landing_sim() {

		uint64_t t_start = time_us_64();

		float pos = landing_sim_input.position;
		float vel = landing_sim_input.velocity;
		float acc = landing_sim_input.acceleration;
		float mass = landing_sim_input.mass;
		float burn_alt = landing_sim_input.burn_alt;
		float work = 0.0f;

		float aero_coeff = 0.0f;
		if ( vel != 0.0 ) { aero_coeff = (mass*acc)/(vel*vel); }

		float time = 0.0f;
		float dt = 0.01f;
		float time_burn_start = 0.0f;

		while ( time < 1.7f && pos > 0.0f ) {

			float force = aero_coeff*vel*vel;

			if ( pos < burn_alt ) {
				if ( time_burn_start == 0 ) { time_burn_start = time; }
				// force += c6_thrust[clamp(int((time-time_burn_start)*100.f), 0, 199)];
				force += d12_thrust[clamp(int((time)*100.f), 0, 166)];
			}

			vel += (-9.816 + (force / mass)) * 0.01;

			float vdt = vel * 0.01;

			work += force * vdt;
			pos += vdt;

			time += dt;

		}

		landing_sim_output.position = pos;
		landing_sim_output.velocity = vel;
		landing_sim_output.time = time;
		landing_sim_output.work_done = work;
		landing_sim_output.time_taken = uint32_t(time_us_64() - t_start);

	}

	// ============================================================
	// divert simulation

	struct divert_sim_input {
		float position;
		float velocity;
		float acceleration;
		float mass;
		float time_since_burn_start;
		float ang_coeff;
	} divert_sim_input;

	struct divert_sim_output {
		float position;
		float velocity;
		float work_done;
		float time;
		uint32_t time_taken;
	} divert_sim_output;

	void run_divert_sim() {

		uint64_t t_start = time_us_64();

		float pos = divert_sim_input.position;
		float vel = divert_sim_input.velocity;
		float acc = divert_sim_input.acceleration;
		float mass = divert_sim_input.mass;
		float time = divert_sim_input.time_since_burn_start;
		float angle_coeff = divert_sim_input.ang_coeff;
		float work = 0.0f;

		float aero_coeff = 0.0f;
		if ( vel != 0.0 ) { aero_coeff = (mass*acc)/(vel*vel); }

		float dt = 0.01f;
		float time_burn_start = 0.0f;

		while ( time < 1.7f && pos > 0.0f ) {

			// float force = c6_thrust[clamp(int((time)*100.f), 0, 199)]*angle_coeff;
			float force = d12_thrust[clamp(int((time)*100.f), 0, 166)]*angle_coeff;
			force += aero_coeff*vel*vel;

			vel += (-9.816 + (force / mass)) * 0.01;

			float vdt = vel * 0.01;

			work += force * vdt;
			pos += vdt;

			time += dt;

		}

		divert_sim_output.position = pos;
		divert_sim_output.velocity = vel;
		divert_sim_output.time = time;
		divert_sim_output.work_done = work;
		divert_sim_output.time_taken = uint32_t(time_us_64() - t_start);

	}

}